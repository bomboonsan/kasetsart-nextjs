<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/components/form/ProjectForm.jsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/components/form/ProjectForm.jsx" />
              <option name="originalContent" value="'use client'&#10;import { useQuery, useMutation } from &quot;@apollo/client/react&quot;;&#10;import { useRouter } from 'next/navigation';&#10;import toast from 'react-hot-toast';&#10;import React from 'react';&#10;import { useEffect, useState, useRef, useMemo, useCallback } from 'react'&#10;import { useSession } from &quot;next-auth/react&quot;;&#10;import Block from '../layout/Block';&#10;import FormInput from '@/components/myui/FormInput';&#10;import FormRadio from '@/components/myui/FormRadio';&#10;import FormTextarea from '@/components/myui/FormTextarea';&#10;import FormDateSelect from '../myui/FormDateSelect';&#10;import FormSelect from '../myui/FormSelect';&#10;import FormMultiSelect from '../myui/FormMultiSelect';&#10;import Partners from &quot;../form/Partners&quot;&#10;import FileUploadField from './FileUploadField';&#10;import { Button } from '../ui/button';&#10;import { PROJECT_FORM_INITIAL, researchKindOptions, fundTypeOptions, subFundType1, subFundType2, subFundType3, subFundType4, fundNameOptions } from '@/data/project';&#10;import { GET_PROJECT_OPTIONS } from '@/graphql/optionForm';&#10;import { CREATE_PROJECT, UPDATE_PROJECT } from '@/graphql/formQueries';&#10;&#10;import { extractInternalUserIds } from '@/utils/partners';&#10;&#10;// Move utility functions outside component to prevent re-creation&#10;const normalizeId = (value) =&gt; {&#10;    if (value === undefined || value === null || value === '') return null;&#10;    const numeric = Number(value);&#10;    if (Number.isFinite(numeric) &amp;&amp; numeric &gt;= 0) {&#10;        return String(numeric);&#10;    }&#10;    const str = String(value).trim();&#10;    return str.length ? str : null;&#10;};&#10;&#10;const parseIntegerOrNull = (value) =&gt; {&#10;    if (value === undefined || value === null || value === '') return null;&#10;    const parsed = Number.parseInt(String(value), 10);&#10;    return Number.isNaN(parsed) ? null : parsed;&#10;};&#10;&#10;const stripTypenameDeep = (input) =&gt; {&#10;    if (typeof input === 'bigint') {&#10;        return input.toString();&#10;    }&#10;    if (Array.isArray(input)) {&#10;        return input&#10;            .map(stripTypenameDeep)&#10;            .filter((item) =&gt; item !== undefined);&#10;    }&#10;    if (input &amp;&amp; typeof input === 'object') {&#10;        return Object.entries(input).reduce((acc, [key, val]) =&gt; {&#10;            if (key === '__typename') return acc;&#10;            const sanitized = stripTypenameDeep(val);&#10;            if (sanitized !== undefined) {&#10;                acc[key] = sanitized;&#10;            }&#10;            return acc;&#10;        }, {});&#10;    }&#10;    return input;&#10;};&#10;&#10;const extractAttachmentIds = (arr) =&gt; {&#10;    if (!Array.isArray(arr)) return [];&#10;    return arr&#10;        .filter(a =&gt; a &amp;&amp; typeof a === 'object' &amp;&amp; (a.documentId || a.id))&#10;        .map(a =&gt; normalizeId(a.documentId ?? a.id))&#10;        .filter(id =&gt; {&#10;            // Accept both numeric IDs and string UUIDs (Strapi v5 uses UUID strings)&#10;            if (!id || id.length === 0) return false;&#10;            const numericId = Number(id);&#10;            const isNumeric = Number.isFinite(numericId) &amp;&amp; numericId &gt; 0;&#10;            const isUUID = typeof id === 'string' &amp;&amp; id.length &gt; 5;&#10;            return isNumeric || isUUID;&#10;        });&#10;};&#10;&#10;const extractSdgIds = (sdgData) =&gt; {&#10;    if (!sdgData) return [];&#10;    if (Array.isArray(sdgData)) {&#10;        return sdgData&#10;            .filter(s =&gt; s &amp;&amp; (s.documentId || s.id))&#10;            .map(s =&gt; normalizeId(s.documentId ?? s.id))&#10;            .filter(Boolean);&#10;    }&#10;    // Handle single value case&#10;    const singleId = normalizeId(sdgData.documentId ?? sdgData.id ?? sdgData);&#10;    return singleId ? [singleId] : [];&#10;};&#10;&#10;export default function ProjectForm({ initialData, onSubmit, isEdit = false }) {&#10;    const router = useRouter();&#10;    const { data: session, status } = useSession();&#10;    const [formData, setFormData] = useState(PROJECT_FORM_INITIAL);&#10;    const [icTypesOptions, setIcTypesOptions] = useState([]);&#10;    const [impactsOptions, setImpactsOptions] = useState([]);&#10;    const [sdgsOptions, setSdgsOptions] = useState([]);&#10;    const [departmentsOptions, setDepartmentsOptions] = useState([]);&#10;    const [isSubmitting, setIsSubmitting] = useState(false);&#10;&#10;    // Memoize computed values&#10;    const isEditing = useMemo(() =&gt; isEdit || Boolean(initialData?.documentId), [isEdit, initialData?.documentId]);&#10;&#10;    // เก็บ attachments เดิมเพื่อเช็คความเปลี่ยนแปลงเวลา update&#10;    const originalAttachmentIdsRef = useRef([]);&#10;&#10;    // Memoize fund sub type options based on fund type&#10;    const fundSubTypeOptions = useMemo(() =&gt; {&#10;        switch (formData.fundType) {&#10;            case &quot;12&quot;: return subFundType1;&#10;            case &quot;11&quot;: return subFundType2;&#10;            case &quot;13&quot;: return subFundType3;&#10;            case &quot;10&quot;: return subFundType4;&#10;            default: return [];&#10;        }&#10;    }, [formData.fundType]);&#10;&#10;    const [createProject] = useMutation(CREATE_PROJECT, {&#10;        context: {&#10;            headers: {&#10;                Authorization: session?.jwt ? `Bearer ${session?.jwt}` : &quot;&quot;&#10;            }&#10;        },&#10;        onError: (error) =&gt; {&#10;            console.error('Create project error:', error);&#10;            toast.error('เกิดข้อผิดพลาดในการสร้างโครงการ: ' + (error?.message || 'ไม่ทราบสาเหตุ'));&#10;        }&#10;    });&#10;&#10;    const [updateProject] = useMutation(UPDATE_PROJECT, {&#10;        context: {&#10;            headers: {&#10;                Authorization: session?.jwt ? `Bearer ${session?.jwt}` : &quot;&quot;&#10;            }&#10;        },&#10;        onError: (error) =&gt; {&#10;            console.error('Update project error:', error);&#10;            toast.error('เกิดข้อผิดพลาดในการอัปเดตโครงการ: ' + (error?.message || 'ไม่ทราบสาเหตุ'));&#10;        }&#10;    });&#10;&#10;    // Memoize input change handler to prevent re-renders&#10;    const handleInputChange = useCallback((field, value) =&gt; {&#10;        setFormData((prev) =&gt; ({ ...prev, [field]: value }));&#10;    }, []);&#10;&#10;    // Check if fundName is &quot;อื่นๆ&quot; or custom value&#10;    const isFundNameOther = useMemo(() =&gt; {&#10;        if (!formData.fundName) return false;&#10;        // Check if fundName is not in the predefined options&#10;        const isInOptions = fundNameOptions.some(opt =&gt; opt.value === formData.fundName);&#10;        return formData.fundName === 'อื่นๆ' || !isInOptions;&#10;    }, [formData.fundName]);&#10;&#10;    // Get display value for fundName select&#10;    const fundNameSelectValue = useMemo(() =&gt; {&#10;        if (!formData.fundName) return &quot;&quot;;&#10;        const isInOptions = fundNameOptions.some(opt =&gt; opt.value === formData.fundName);&#10;        return isInOptions ? formData.fundName : 'อื่นๆ';&#10;    }, [formData.fundName]);&#10;&#10;    // Memoize submit handler to prevent re-creation&#10;    const handleSubmit = useCallback(async () =&gt; {&#10;        if (!session?.jwt) {&#10;            toast.error('กรุณาเข้าสู่ระบบก่อนบันทึกข้อมูล');&#10;            return;&#10;        }&#10;&#10;        // Basic validation&#10;        // if (!formData.nameTH?.trim()) {&#10;        //     toast.error('กรุณากรอกชื่อโครงการภาษาไทย');&#10;        //     return;&#10;        // }&#10;&#10;        if (!formData.fiscalYear) {&#10;            toast.error('กรุณากรอกปีงบประมาณ');&#10;            return;&#10;        }&#10;&#10;        setIsSubmitting(true);&#10;&#10;        try {&#10;            const usersPermissionsUsers = Array.from(new Set(extractInternalUserIds(formData.partners).map(normalizeId).filter(Boolean)));&#10;&#10;            const attachmentIds = Array.from(new Set(extractAttachmentIds(formData.attachments)));&#10;&#10;            // When editing, merge original IDs with new IDs to ensure old files are preserved&#10;            const finalAttachmentIds = isEditing&#10;                ? Array.from(new Set([...(originalAttachmentIdsRef.current || []), ...attachmentIds]))&#10;                : attachmentIds;&#10;&#10;            const originalIdsSorted = [...(originalAttachmentIdsRef.current || [])].sort();&#10;            const currentIdsSorted = [...finalAttachmentIds].sort();&#10;            const attachmentsChanged = JSON.stringify(originalIdsSorted) !== JSON.stringify(currentIdsSorted);&#10;&#10;            const toIdArray = (value) =&gt; {&#10;                const normalized = normalizeId(value);&#10;                return normalized ? [normalized] : [];&#10;            };&#10;&#10;            const toSdgIdArray = (value) =&gt; {&#10;                if (!value) return [];&#10;                if (Array.isArray(value)) {&#10;                    return value.map(v =&gt; normalizeId(v)).filter(Boolean);&#10;                }&#10;                const normalized = normalizeId(value);&#10;                return normalized ? [normalized] : [];&#10;            };&#10;&#10;            const projectData = {&#10;                fiscalYear: parseIntegerOrNull(formData.fiscalYear),&#10;                projectType: formData.projectType || null,&#10;                projectMode: formData.projectMode || null,&#10;                subProjectCount: formData.subProjectCount,&#10;                nameTH: formData.nameTH?.trim() || null,&#10;                nameEN: formData.nameEN?.trim() || null,&#10;                isEnvironmentallySustainable: formData.isEnvironmentallySustainable || null,&#10;                durationStart: formData.durationStart || null,&#10;                durationEnd: formData.durationEnd || null,&#10;                researchKind: formData.researchKind || null,&#10;                fundType: formData.fundType || null,&#10;                fundSubType: formData.fundSubType || null,&#10;                fundName: formData.fundName || null,&#10;                budget: parseIntegerOrNull(formData.budget),&#10;                keywords: formData.keywords || null,&#10;                departments: toIdArray(formData.departments),&#10;                ic_types: toIdArray(formData.icTypes),&#10;                impacts: toIdArray(formData.impact),&#10;                sdgs: toSdgIdArray(formData.sdg),&#10;                partners: Array.isArray(formData.partners) ? stripTypenameDeep(formData.partners) : [],&#10;                attachments: finalAttachmentIds.length ? finalAttachmentIds : [],&#10;                users_permissions_users: usersPermissionsUsers&#10;            };&#10;&#10;            // Remove null/undefined values to avoid issues&#10;            // Object.keys(projectData).forEach(key =&gt; {&#10;            //     if (projectData[key] === undefined || projectData[key] === null || projectData[key] === &quot;&quot;) {&#10;            //         delete projectData[key];&#10;            //     }&#10;            // });&#10;&#10;            // Sanitize projectData to avoid sending BigInt values (GraphQL cannot serialize BigInt)&#10;            if (isEditing &amp;&amp; !attachmentsChanged) {&#10;                delete projectData.attachments;&#10;            }&#10;&#10;            const safeProjectData = stripTypenameDeep(projectData);&#10;&#10;            if (onSubmit) {&#10;                await onSubmit(safeProjectData);&#10;                if (isEditing) {&#10;                    originalAttachmentIdsRef.current = finalAttachmentIds;&#10;                }&#10;            } else if (isEditing) {&#10;                const targetId = normalizeId(initialData?.documentId);&#10;                if (!targetId) {&#10;                    throw new Error('ไม่พบรหัสโครงการสำหรับการแก้ไข');&#10;                }&#10;                const updateResult = await updateProject({&#10;                    variables: {&#10;                        documentId: targetId,&#10;                        data: safeProjectData&#10;                    }&#10;                });&#10;                if (!updateResult?.data?.updateProject?.documentId) {&#10;                    throw new Error('ไม่สามารถอัปเดตโครงการได้ กรุณาลองอีกครั้ง');&#10;                }&#10;                toast.success('อัปเดตโครงการสำเร็จแล้ว!');&#10;                originalAttachmentIdsRef.current = finalAttachmentIds;&#10;                router.refresh();&#10;                router.push(`/form/project/view/${targetId}`);&#10;            } else {&#10;                const createResult = await createProject({&#10;                    variables: {&#10;                        data: safeProjectData&#10;                    }&#10;                });&#10;                const createdId = normalizeId(createResult?.data?.createProject?.documentId);&#10;                if (!createdId) {&#10;                    throw new Error('ไม่สามารถสร้างโครงการได้ กรุณาลองอีกครั้ง');&#10;                }&#10;                toast.success('บันทึกโครงการสำเร็จแล้ว!');&#10;                // router.refresh();&#10;                // router.push(`/form/project/view/${createdId}`);&#10;                setTimeout(() =&gt; {&#10;                    window.location.href = `/form/project/view/${createdId}`;&#10;                }, 1000);&#10;            }&#10;        } catch (error) {&#10;            console.error('Submission error:', error);&#10;            toast.error('เกิดข้อผิดพลาดในการบันทึก: ' + (error?.message || 'ไม่ทราบสาเหตุ'));&#10;        } finally {&#10;            setIsSubmitting(false);&#10;        }&#10;    }, [session?.jwt, formData, isEditing, initialData?.documentId, onSubmit, updateProject, createProject]);&#10;&#10;    // hydrate when editing - memoize to prevent unnecessary re-renders&#10;    useEffect(() =&gt; {&#10;        if (initialData) {&#10;            const normalizedIcType = normalizeId(initialData.ic_types?.[0]?.documentId ?? initialData.icTypes);&#10;            const normalizedImpact = normalizeId(initialData.impacts?.[0]?.documentId ?? initialData.impact);&#10;            // Handle SDG as array - extract all SDG IDs&#10;            const normalizedSdgArray = extractSdgIds(initialData.sdgs ?? initialData.sdg);&#10;            const normalizedDepartment = normalizeId(initialData.departments?.[0]?.documentId ?? initialData.departments);&#10;            const hydrated = {&#10;                ...PROJECT_FORM_INITIAL,&#10;                ...initialData,&#10;                // map relations to expected values&#10;                icTypes: normalizedIcType ?? &quot;&quot;,&#10;                impact: normalizedImpact ?? &quot;&quot;,&#10;                sdg: normalizedSdgArray, // Now an array&#10;                departments: normalizedDepartment ?? &quot;&quot;,&#10;            };&#10;            setFormData(hydrated);&#10;            originalAttachmentIdsRef.current = extractAttachmentIds(hydrated.attachments);&#10;        }&#10;    }, [initialData]); // Only depend on initialData, not its nested properties&#10;&#10;    const { data: projectOptions, loading: projectOptionsLoading, error: projectOptionsError } = useQuery(GET_PROJECT_OPTIONS, {&#10;        skip: status !== 'authenticated',&#10;        context: {&#10;            headers: {&#10;                Authorization: session?.jwt ? `Bearer ${session?.jwt}` : &quot;&quot;&#10;            }&#10;        },&#10;        onError: (error) =&gt; {&#10;            console.error('Project options query error:', error);&#10;            toast.error('เกิดข้อผิดพลาดในการโหลดตัวเลือก: ' + (error?.message || 'ไม่ทราบสาเหตุ'));&#10;        }&#10;    });&#10;&#10;    // Memoize options processing to prevent unnecessary recalculations&#10;    const memoizedOptions = useMemo(() =&gt; {&#10;        if (!projectOptions) {&#10;            return {&#10;                icTypes: [],&#10;                impacts: [],&#10;                sdgs: [],&#10;                departments: []&#10;            };&#10;        }&#10;&#10;        return {&#10;            icTypes: (projectOptions.icTypes ?? []).map(ic =&gt; ({&#10;                value: String(ic.documentId),&#10;                label: ic.name&#10;            })),&#10;            impacts: (projectOptions.impacts ?? []).map(imp =&gt; ({&#10;                value: String(imp.documentId),&#10;                label: imp.name&#10;            })),&#10;            sdgs: (projectOptions.sdgs ?? []).map(sdg =&gt; ({&#10;                value: String(sdg.documentId),&#10;                label: sdg.name&#10;            })),&#10;            departments: (projectOptions.departments ?? []).filter(d =&gt; d.title !== 'สํานักงานเลขานุการ').map(dep =&gt; ({&#10;                value: String(dep.documentId),&#10;                label: dep.title&#10;            }))&#10;        };&#10;    }, [projectOptions]);&#10;&#10;    // Update options state only when memoizedOptions change&#10;    useEffect(() =&gt; {&#10;        setIcTypesOptions(memoizedOptions.icTypes);&#10;        setImpactsOptions(memoizedOptions.impacts);&#10;        setSdgsOptions(memoizedOptions.sdgs);&#10;        setDepartmentsOptions(memoizedOptions.departments);&#10;    }, [memoizedOptions]);&#10;&#10;    // Early return with loading state and error handling&#10;    if (status === 'loading' || projectOptionsLoading) {&#10;        return &lt;div className=&quot;flex items-center justify-center p-8&quot;&gt;&#10;            &lt;p&gt;Loading form...&lt;/p&gt;&#10;        &lt;/div&gt;;&#10;    }&#10;&#10;    if (projectOptionsError) {&#10;        return &lt;div className=&quot;flex items-center justify-center p-8&quot;&gt;&#10;            &lt;p className=&quot;text-red-600&quot;&gt;Error loading form options. Please refresh the page.&lt;/p&gt;&#10;        &lt;/div&gt;;&#10;    }&#10;&#10;    if (!formData) {&#10;        return &lt;div className=&quot;flex items-center justify-center p-8&quot;&gt;&#10;            &lt;p&gt;Initializing form...&lt;/p&gt;&#10;        &lt;/div&gt;;&#10;    }&#10;&#10;    return (&#10;        &lt;&gt;&#10;            &lt;Block&gt;&#10;                &lt;div className=&quot;inputGroup&quot;&gt;&#10;                    &lt;FormInput id=&quot;fiscalYear&quot; label=&quot;ปีงบประมาณ&quot; value={formData.fiscalYear} placeholder=&quot;กรอกปีงบประมาณ&quot; onChange={(e) =&gt; handleInputChange('fiscalYear', e.target.value)} /&gt;&#10;                    &lt;FormRadio id=&quot;projectType&quot; label=&quot;ประเภทโครงการ&quot; value={formData.projectType} onChange={(e) =&gt; handleInputChange('projectType', e.target.value)} options={[&#10;                        { value: '0', label: 'โครงการวิจัย' },&#10;                        { value: '1', label: 'โครงการพัฒนาวิชาการประเภทงานวิจัย' },&#10;                    ]} /&gt;&#10;                    &lt;FormRadio id=&quot;projectMode&quot; label=&quot;ลักษณะโครงการวิจัย&quot; value={formData.projectMode} onChange={(e) =&gt; handleInputChange('projectMode', e.target.value)} options={[&#10;                        { value: '0', label: 'โครงการวิจัยเดี่ยว' },&#10;                        { value: '1', label: 'แผนงานวิจัย หรือชุดโครงการวิจัย' },&#10;                    ]} /&gt;&#10;                    &lt;FormInput id=&quot;subProjectCount&quot; disabled={formData.projectMode == '0' || formData.projectMode == ''} type=&quot;number&quot; label=&quot;จำนวนโครงการย่อย&quot; value={formData.subProjectCount} placeholder=&quot;กรอกจำนวนโครงการย่อย&quot; onChange={(e) =&gt; handleInputChange('subProjectCount', e.target.value)} /&gt;&#10;                    {/* &lt;FormInput id=&quot;project-name&quot; label=&quot;ชื่อโครงการ&quot; value=&quot;&quot; placeholder=&quot;กรอกชื่อโครงการ&quot; /&gt; */}&#10;                    &lt;FormTextarea id=&quot;nameTH&quot; label=&quot;ชื่อแผนงานวิจัยหรือชุดโครงการวิจัย/โครงการวิจัย (ไทย)&quot; value={formData.nameTH} onChange={(e) =&gt; handleInputChange('nameTH', e.target.value)} placeholder=&quot;&quot; rows={5} /&gt;&#10;                    &lt;FormTextarea id=&quot;nameEN&quot; label=&quot;ชื่อแผนงานวิจัยหรือชุดโครงการวิจัย/โครงการวิจัย (อังกฤษ)&quot; value={formData.nameEN} onChange={(e) =&gt; handleInputChange('nameEN', e.target.value)} placeholder=&quot;&quot; rows={5} /&gt;&#10;                    &lt;FormRadio id=&quot;isEnvironmentallySustainable&quot; label=&quot;&quot; value={formData.isEnvironmentallySustainable} onChange={(e) =&gt; handleInputChange('isEnvironmentallySustainable', e.target.value)} options={[&#10;                        { value: '0', label: 'เกี่ยวข้อง กับสิ่งแวดล้อมและความยั่งยืน' },&#10;                        { value: '1', label: 'ไม่เกี่ยวข้อง กับสิ่งแวดล้อมและความยั่งยืน' },&#10;                    ]} /&gt;&#10;                    &lt;FormDateSelect durationStart={formData.durationStart} durationEnd={formData.durationEnd} durationStartChange={(field, value) =&gt; handleInputChange(field, value)} durationEndChange={(field, value) =&gt; handleInputChange(field, value)} noDay={false}&gt;&#10;                        ระยะเวลาการทำวิจัย{&quot; &quot;}&#10;                        &lt;span className=&quot;text-blue-700&quot;&gt;(ปี พ.ศ. 4 หลัก)&lt;/span&gt;&#10;                        &lt;span className=&quot;text-red-500 ml-1&quot;&gt;*&lt;/span&gt;&#10;                    &lt;/FormDateSelect&gt;&#10;                    {/* &lt;FormTextarea id=&quot;responsibleOrganization&quot; label=&quot;หน่วยงานหลักที่รับผิดชอบโครงการวิจัย (หน่วยงานที่ขอทุน)&quot; value={formData.responsibleOrganization} onChange={(e) =&gt; handleInputChange('responsibleOrganization', e.target.value)} placeholder=&quot;&quot; rows={5} /&gt; */}&#10;                    &lt;FormSelect id=&quot;departments&quot; label=&quot;หน่วยงานหลักที่รับผิดชอบโครงการวิจัย (หน่วยงานที่ขอทุน)&quot; value={formData.departments ?? &quot;&quot;} placeholder=&quot;เลือกหน่วยงาน&quot; onChange={(val) =&gt; handleInputChange('departments', val)} options={departmentsOptions} /&gt;&#10;                    &lt;FormSelect id=&quot;researchKind&quot; label=&quot;ประเภทงานวิจัย&quot; value={formData.researchKind ?? &quot;&quot;} placeholder=&quot;เลือกประเภทงานวิจัย&quot; onChange={(val) =&gt; handleInputChange('researchKind', val)} options={researchKindOptions} /&gt;&#10;                    &lt;FormSelect id=&quot;fundType&quot; label=&quot;ประเภทแหล่งทุน&quot; disabled={formData.researchKind == &quot;&quot;} value={formData.fundType ?? &quot;&quot;} placeholder=&quot;เลือกประเภทแหล่งทุน&quot; onChange={(val) =&gt; handleInputChange('fundType', val)} options={fundTypeOptions} /&gt;&#10;                    {fundSubTypeOptions.length &gt; 0 &amp;&amp; (&#10;                        &lt;FormSelect id=&quot;fundSubType&quot; label=&quot; &quot; value={formData.fundSubType ?? &quot;&quot;} placeholder=&quot;เลือกประเภทแหล่งทุน&quot; onChange={(val) =&gt; handleInputChange('fundSubType', val)} options={fundSubTypeOptions} /&gt;&#10;                    )}&#10;                    &lt;FormSelect id=&quot;fundName&quot; label=&quot;ชื่อแหล่งทุน&quot; disabled={formData.fundSubType == &quot;&quot;} value={fundNameSelectValue} placeholder=&quot;ชื่อแหล่งทุน&quot; onChange={(val) =&gt; handleInputChange('fundName', val)} options={fundNameOptions} /&gt;&#10;                    {isFundNameOther &amp;&amp; (&#10;                        &lt;FormTextarea&#10;                            label=&quot;ระบุชื่อแหล่งทุน&quot;&#10;                            value={formData.fundName === 'อื่นๆ' ? '' : formData.fundName}&#10;                            onChange={(e) =&gt; handleInputChange('fundName', e.target.value)}&#10;                            placeholder=&quot;กรุณาระบุชื่อแหล่งทุน&quot;&#10;                            rows={3}&#10;                        /&gt;&#10;                    )}&#10;                    &lt;FormInput id=&quot;budget&quot; type='number' label=&quot;งบวิจัย&quot; value={formData.budget} placeholder=&quot;0&quot; onChange={(e) =&gt; handleInputChange('budget', e.target.value)} /&gt;&#10;                    &lt;FormTextarea id=&quot;keywords&quot; label=&quot;คำสำคัญ (คั่นระหว่างคำด้วยเครื่องหมาย “;” เช่น ข้าว; พืช; อาหาร)&quot; value={formData.keywords} onChange={(e) =&gt; handleInputChange('keywords', e.target.value)} placeholder=&quot;&quot; rows={5} /&gt;&#10;                    &lt;FormSelect id=&quot;icTypes&quot; label=&quot;IC Types&quot; value={formData.icTypes ?? &quot;&quot;} placeholder=&quot;เลือก IC Types&quot; onChange={(val) =&gt; handleInputChange('icTypes', val)} options={icTypesOptions} /&gt;&#10;                    &lt;FormSelect id=&quot;impact&quot; label=&quot;Impact&quot; value={formData.impact ?? &quot;&quot;} placeholder=&quot;เลือก Impact&quot; onChange={(val) =&gt; handleInputChange('impact', val)} options={impactsOptions} /&gt;&#10;                    &lt;FormMultiSelect id=&quot;sdgs&quot; label=&quot;SDG&quot; value={formData.sdg ?? []} placeholder=&quot;เลือก SDG&quot; onChange={(val) =&gt; handleInputChange('sdg', val)} options={sdgsOptions} /&gt;&#10;                    &lt;FileUploadField&#10;                        label=&quot;เอกสารแนบ&quot;&#10;                        value={formData.attachments || []}&#10;                        onFilesChange={(files) =&gt; handleInputChange('attachments', files)}&#10;                    /&gt;&#10;                &lt;/div&gt;&#10;            &lt;/Block&gt;&#10;            &lt;Block className=&quot;mt-4&quot;&gt;&#10;                &lt;Partners data={formData.partners} onChange={(partners) =&gt; handleInputChange('partners', partners)} /&gt;&#10;            &lt;/Block&gt;&#10;            &lt;div className='flex justify-end items-center gap-3 mt-4'&gt;&#10;                &lt;Button onClick={() =&gt; router.back()} variant=&quot;outline&quot;&gt;ยกเลิก&lt;/Button&gt;&#10;                &lt;Button&#10;                    variant=&quot;default&quot;&#10;                    onClick={handleSubmit}&#10;                    disabled={isSubmitting}&#10;                &gt;&#10;                    {isSubmitting ? 'กำลังบันทึก...' : 'บันทึก'}&#10;                &lt;/Button&gt;&#10;            &lt;/div&gt;&#10;        &lt;/&gt;&#10;    );&#10;}&#10;" />
              <option name="updatedContent" value="'use client'&#10;import { useQuery, useMutation } from &quot;@apollo/client/react&quot;;&#10;import { useRouter } from 'next/navigation';&#10;import toast from 'react-hot-toast';&#10;import React from 'react';&#10;import { useEffect, useState, useRef, useMemo, useCallback } from 'react'&#10;import { useSession } from &quot;next-auth/react&quot;;&#10;import Block from '../layout/Block';&#10;import FormInput from '@/components/myui/FormInput';&#10;import FormRadio from '@/components/myui/FormRadio';&#10;import FormTextarea from '@/components/myui/FormTextarea';&#10;import FormDateSelect from '../myui/FormDateSelect';&#10;import FormSelect from '../myui/FormSelect';&#10;import FormMultiSelect from '../myui/FormMultiSelect';&#10;import Partners from &quot;../form/Partners&quot;&#10;import FileUploadField from './FileUploadField';&#10;import { Button } from '../ui/button';&#10;import { PROJECT_FORM_INITIAL, researchKindOptions, fundTypeOptions, subFundType1, subFundType2, subFundType3, subFundType4, fundNameOptions } from '@/data/project';&#10;import { GET_PROJECT_OPTIONS } from '@/graphql/optionForm';&#10;import { CREATE_PROJECT, UPDATE_PROJECT } from '@/graphql/formQueries';&#10;&#10;import { extractInternalUserIds } from '@/utils/partners';&#10;&#10;// Add BigInt serialization support for JSON.stringify&#10;if (typeof BigInt !== 'undefined') {&#10;    // @ts-ignore&#10;    BigInt.prototype.toJSON = function() { return this.toString(); };&#10;}&#10;&#10;// Move utility functions outside component to prevent re-creation&#10;const normalizeId = (value) =&gt; {&#10;    if (value === undefined || value === null || value === '') return null;&#10;    const numeric = Number(value);&#10;    if (Number.isFinite(numeric) &amp;&amp; numeric &gt;= 0) {&#10;        return String(numeric);&#10;    }&#10;    const str = String(value).trim();&#10;    return str.length ? str : null;&#10;};&#10;&#10;const parseIntegerOrNull = (value) =&gt; {&#10;    if (value === undefined || value === null || value === '') return null;&#10;    const parsed = Number.parseInt(String(value), 10);&#10;    return Number.isNaN(parsed) ? null : parsed;&#10;};&#10;&#10;const stripTypenameDeep = (input) =&gt; {&#10;    // Handle null explicitly&#10;    if (input === null) {&#10;        return null;&#10;    }&#10;    // Handle undefined&#10;    if (input === undefined) {&#10;        return undefined;&#10;    }&#10;    // Handle BigInt - convert to string&#10;    if (typeof input === 'bigint') {&#10;        return input.toString();&#10;    }&#10;    // Handle arrays&#10;    if (Array.isArray(input)) {&#10;        return input&#10;            .map(stripTypenameDeep)&#10;            .filter((item) =&gt; item !== undefined);&#10;    }&#10;    // Handle objects&#10;    if (typeof input === 'object') {&#10;        return Object.entries(input).reduce((acc, [key, val]) =&gt; {&#10;            if (key === '__typename') return acc;&#10;            const sanitized = stripTypenameDeep(val);&#10;            // Keep null values but remove undefined&#10;            if (sanitized !== undefined) {&#10;                acc[key] = sanitized;&#10;            }&#10;            return acc;&#10;        }, {});&#10;    }&#10;    // Handle primitives (string, number, boolean)&#10;    return input;&#10;};&#10;&#10;const extractAttachmentIds = (arr) =&gt; {&#10;    if (!Array.isArray(arr)) return [];&#10;    return arr&#10;        .filter(a =&gt; a &amp;&amp; typeof a === 'object' &amp;&amp; (a.documentId || a.id))&#10;        .map(a =&gt; normalizeId(a.documentId ?? a.id))&#10;        .filter(id =&gt; {&#10;            // Accept both numeric IDs and string UUIDs (Strapi v5 uses UUID strings)&#10;            if (!id || id.length === 0) return false;&#10;            const numericId = Number(id);&#10;            const isNumeric = Number.isFinite(numericId) &amp;&amp; numericId &gt; 0;&#10;            const isUUID = typeof id === 'string' &amp;&amp; id.length &gt; 5;&#10;            return isNumeric || isUUID;&#10;        });&#10;};&#10;&#10;const extractSdgIds = (sdgData) =&gt; {&#10;    if (!sdgData) return [];&#10;    if (Array.isArray(sdgData)) {&#10;        return sdgData&#10;            .filter(s =&gt; s &amp;&amp; (s.documentId || s.id))&#10;            .map(s =&gt; normalizeId(s.documentId ?? s.id))&#10;            .filter(Boolean);&#10;    }&#10;    // Handle single value case&#10;    const singleId = normalizeId(sdgData.documentId ?? sdgData.id ?? sdgData);&#10;    return singleId ? [singleId] : [];&#10;};&#10;&#10;export default function ProjectForm({ initialData, onSubmit, isEdit = false }) {&#10;    const router = useRouter();&#10;    const { data: session, status } = useSession();&#10;    const [formData, setFormData] = useState(PROJECT_FORM_INITIAL);&#10;    const [icTypesOptions, setIcTypesOptions] = useState([]);&#10;    const [impactsOptions, setImpactsOptions] = useState([]);&#10;    const [sdgsOptions, setSdgsOptions] = useState([]);&#10;    const [departmentsOptions, setDepartmentsOptions] = useState([]);&#10;    const [isSubmitting, setIsSubmitting] = useState(false);&#10;&#10;    // Memoize computed values&#10;    const isEditing = useMemo(() =&gt; isEdit || Boolean(initialData?.documentId), [isEdit, initialData?.documentId]);&#10;&#10;    // เก็บ attachments เดิมเพื่อเช็คความเปลี่ยนแปลงเวลา update&#10;    const originalAttachmentIdsRef = useRef([]);&#10;&#10;    // Memoize fund sub type options based on fund type&#10;    const fundSubTypeOptions = useMemo(() =&gt; {&#10;        switch (formData.fundType) {&#10;            case &quot;12&quot;: return subFundType1;&#10;            case &quot;11&quot;: return subFundType2;&#10;            case &quot;13&quot;: return subFundType3;&#10;            case &quot;10&quot;: return subFundType4;&#10;            default: return [];&#10;        }&#10;    }, [formData.fundType]);&#10;&#10;    const [createProject] = useMutation(CREATE_PROJECT, {&#10;        context: {&#10;            headers: {&#10;                Authorization: session?.jwt ? `Bearer ${session?.jwt}` : &quot;&quot;&#10;            }&#10;        },&#10;        onError: (error) =&gt; {&#10;            console.error('Create project error:', error);&#10;            toast.error('เกิดข้อผิดพลาดในการสร้างโครงการ: ' + (error?.message || 'ไม่ทราบสาเหตุ'));&#10;        }&#10;    });&#10;&#10;    const [updateProject] = useMutation(UPDATE_PROJECT, {&#10;        context: {&#10;            headers: {&#10;                Authorization: session?.jwt ? `Bearer ${session?.jwt}` : &quot;&quot;&#10;            }&#10;        },&#10;        onError: (error) =&gt; {&#10;            console.error('Update project error:', error);&#10;            toast.error('เกิดข้อผิดพลาดในการอัปเดตโครงการ: ' + (error?.message || 'ไม่ทราบสาเหตุ'));&#10;        }&#10;    });&#10;&#10;    // Memoize input change handler to prevent re-renders&#10;    const handleInputChange = useCallback((field, value) =&gt; {&#10;        setFormData((prev) =&gt; ({ ...prev, [field]: value }));&#10;    }, []);&#10;&#10;    // Check if fundName is &quot;อื่นๆ&quot; or custom value&#10;    const isFundNameOther = useMemo(() =&gt; {&#10;        if (!formData.fundName) return false;&#10;        // Check if fundName is not in the predefined options&#10;        const isInOptions = fundNameOptions.some(opt =&gt; opt.value === formData.fundName);&#10;        return formData.fundName === 'อื่นๆ' || !isInOptions;&#10;    }, [formData.fundName]);&#10;&#10;    // Get display value for fundName select&#10;    const fundNameSelectValue = useMemo(() =&gt; {&#10;        if (!formData.fundName) return &quot;&quot;;&#10;        const isInOptions = fundNameOptions.some(opt =&gt; opt.value === formData.fundName);&#10;        return isInOptions ? formData.fundName : 'อื่นๆ';&#10;    }, [formData.fundName]);&#10;&#10;    // Memoize submit handler to prevent re-creation&#10;    const handleSubmit = useCallback(async () =&gt; {&#10;        if (!session?.jwt) {&#10;            toast.error('กรุณาเข้าสู่ระบบก่อนบันทึกข้อมูล');&#10;            return;&#10;        }&#10;&#10;        // Basic validation&#10;        // if (!formData.nameTH?.trim()) {&#10;        //     toast.error('กรุณากรอกชื่อโครงการภาษาไทย');&#10;        //     return;&#10;        // }&#10;&#10;        if (!formData.fiscalYear) {&#10;            toast.error('กรุณากรอกปีงบประมาณ');&#10;            return;&#10;        }&#10;&#10;        setIsSubmitting(true);&#10;&#10;        try {&#10;            const usersPermissionsUsers = Array.from(new Set(extractInternalUserIds(formData.partners).map(normalizeId).filter(Boolean)));&#10;&#10;            const attachmentIds = Array.from(new Set(extractAttachmentIds(formData.attachments)));&#10;&#10;            // When editing, merge original IDs with new IDs to ensure old files are preserved&#10;            const finalAttachmentIds = isEditing&#10;                ? Array.from(new Set([...(originalAttachmentIdsRef.current || []), ...attachmentIds]))&#10;                : attachmentIds;&#10;&#10;            const originalIdsSorted = [...(originalAttachmentIdsRef.current || [])].sort();&#10;            const currentIdsSorted = [...finalAttachmentIds].sort();&#10;            const attachmentsChanged = JSON.stringify(originalIdsSorted) !== JSON.stringify(currentIdsSorted);&#10;&#10;            const toIdArray = (value) =&gt; {&#10;                const normalized = normalizeId(value);&#10;                return normalized ? [normalized] : [];&#10;            };&#10;&#10;            const toSdgIdArray = (value) =&gt; {&#10;                if (!value) return [];&#10;                if (Array.isArray(value)) {&#10;                    return value.map(v =&gt; normalizeId(v)).filter(Boolean);&#10;                }&#10;                const normalized = normalizeId(value);&#10;                return normalized ? [normalized] : [];&#10;            };&#10;&#10;            const projectData = {&#10;                fiscalYear: parseIntegerOrNull(formData.fiscalYear),&#10;                projectType: formData.projectType || null,&#10;                projectMode: formData.projectMode || null,&#10;                subProjectCount: formData.subProjectCount,&#10;                nameTH: formData.nameTH?.trim() || null,&#10;                nameEN: formData.nameEN?.trim() || null,&#10;                isEnvironmentallySustainable: formData.isEnvironmentallySustainable || null,&#10;                durationStart: formData.durationStart || null,&#10;                durationEnd: formData.durationEnd || null,&#10;                researchKind: formData.researchKind || null,&#10;                fundType: formData.fundType || null,&#10;                fundSubType: formData.fundSubType || null,&#10;                fundName: formData.fundName || null,&#10;                budget: parseIntegerOrNull(formData.budget),&#10;                keywords: formData.keywords || null,&#10;                departments: toIdArray(formData.departments),&#10;                ic_types: toIdArray(formData.icTypes),&#10;                impacts: toIdArray(formData.impact),&#10;                sdgs: toSdgIdArray(formData.sdg),&#10;                partners: Array.isArray(formData.partners) ? stripTypenameDeep(formData.partners) : [],&#10;                attachments: finalAttachmentIds.length ? finalAttachmentIds : [],&#10;                users_permissions_users: usersPermissionsUsers&#10;            };&#10;&#10;            // Remove null/undefined values to avoid issues&#10;            // Object.keys(projectData).forEach(key =&gt; {&#10;            //     if (projectData[key] === undefined || projectData[key] === null || projectData[key] === &quot;&quot;) {&#10;            //         delete projectData[key];&#10;            //     }&#10;            // });&#10;&#10;            // Sanitize projectData to avoid sending BigInt values (GraphQL cannot serialize BigInt)&#10;            if (isEditing &amp;&amp; !attachmentsChanged) {&#10;                delete projectData.attachments;&#10;            }&#10;&#10;            const safeProjectData = stripTypenameDeep(projectData);&#10;&#10;            if (onSubmit) {&#10;                await onSubmit(safeProjectData);&#10;                if (isEditing) {&#10;                    originalAttachmentIdsRef.current = finalAttachmentIds;&#10;                }&#10;            } else if (isEditing) {&#10;                const targetId = normalizeId(initialData?.documentId);&#10;                if (!targetId) {&#10;                    throw new Error('ไม่พบรหัสโครงการสำหรับการแก้ไข');&#10;                }&#10;                const updateResult = await updateProject({&#10;                    variables: {&#10;                        documentId: targetId,&#10;                        data: safeProjectData&#10;                    }&#10;                });&#10;                if (!updateResult?.data?.updateProject?.documentId) {&#10;                    throw new Error('ไม่สามารถอัปเดตโครงการได้ กรุณาลองอีกครั้ง');&#10;                }&#10;                toast.success('อัปเดตโครงการสำเร็จแล้ว!');&#10;                originalAttachmentIdsRef.current = finalAttachmentIds;&#10;                router.refresh();&#10;                router.push(`/form/project/view/${targetId}`);&#10;            } else {&#10;                const createResult = await createProject({&#10;                    variables: {&#10;                        data: safeProjectData&#10;                    }&#10;                });&#10;                const createdId = normalizeId(createResult?.data?.createProject?.documentId);&#10;                if (!createdId) {&#10;                    throw new Error('ไม่สามารถสร้างโครงการได้ กรุณาลองอีกครั้ง');&#10;                }&#10;                toast.success('บันทึกโครงการสำเร็จแล้ว!');&#10;                // router.refresh();&#10;                // router.push(`/form/project/view/${createdId}`);&#10;                setTimeout(() =&gt; {&#10;                    window.location.href = `/form/project/view/${createdId}`;&#10;                }, 1000);&#10;            }&#10;        } catch (error) {&#10;            console.error('Submission error:', error);&#10;            toast.error('เกิดข้อผิดพลาดในการบันทึก: ' + (error?.message || 'ไม่ทราบสาเหตุ'));&#10;        } finally {&#10;            setIsSubmitting(false);&#10;        }&#10;    }, [session?.jwt, formData, isEditing, initialData?.documentId, onSubmit, updateProject, createProject]);&#10;&#10;    // hydrate when editing - memoize to prevent unnecessary re-renders&#10;    useEffect(() =&gt; {&#10;        if (initialData) {&#10;            // Clean initialData from BigInt values before processing&#10;            const cleanedData = stripTypenameDeep(initialData);&#10;            &#10;            const normalizedIcType = normalizeId(cleanedData.ic_types?.[0]?.documentId ?? cleanedData.icTypes);&#10;            const normalizedImpact = normalizeId(cleanedData.impacts?.[0]?.documentId ?? cleanedData.impact);&#10;            // Handle SDG as array - extract all SDG IDs&#10;            const normalizedSdgArray = extractSdgIds(cleanedData.sdgs ?? cleanedData.sdg);&#10;            &#10;            // Properly handle departments - check if it's an array and has items&#10;            let normalizedDepartment = &quot;&quot;;&#10;            if (Array.isArray(cleanedData.departments) &amp;&amp; cleanedData.departments.length &gt; 0) {&#10;                normalizedDepartment = normalizeId(cleanedData.departments[0]?.documentId);&#10;            } else if (cleanedData.departments &amp;&amp; !Array.isArray(cleanedData.departments)) {&#10;                normalizedDepartment = normalizeId(cleanedData.departments.documentId ?? cleanedData.departments);&#10;            }&#10;            &#10;            const hydrated = {&#10;                ...PROJECT_FORM_INITIAL,&#10;                ...cleanedData,&#10;                // map relations to expected values&#10;                icTypes: normalizedIcType ?? &quot;&quot;,&#10;                impact: normalizedImpact ?? &quot;&quot;,&#10;                sdg: normalizedSdgArray, // Now an array&#10;                departments: normalizedDepartment ?? &quot;&quot;,&#10;            };&#10;            setFormData(hydrated);&#10;            originalAttachmentIdsRef.current = extractAttachmentIds(hydrated.attachments);&#10;        }&#10;    }, [initialData]); // Only depend on initialData, not its nested properties&#10;&#10;    const { data: projectOptions, loading: projectOptionsLoading, error: projectOptionsError } = useQuery(GET_PROJECT_OPTIONS, {&#10;        skip: status !== 'authenticated',&#10;        context: {&#10;            headers: {&#10;                Authorization: session?.jwt ? `Bearer ${session?.jwt}` : &quot;&quot;&#10;            }&#10;        },&#10;        onError: (error) =&gt; {&#10;            console.error('Project options query error:', error);&#10;            toast.error('เกิดข้อผิดพลาดในการโหลดตัวเลือก: ' + (error?.message || 'ไม่ทราบสาเหตุ'));&#10;        }&#10;    });&#10;&#10;    // Memoize options processing to prevent unnecessary recalculations&#10;    const memoizedOptions = useMemo(() =&gt; {&#10;        if (!projectOptions) {&#10;            return {&#10;                icTypes: [],&#10;                impacts: [],&#10;                sdgs: [],&#10;                departments: []&#10;            };&#10;        }&#10;&#10;        return {&#10;            icTypes: (projectOptions.icTypes ?? []).map(ic =&gt; ({&#10;                value: String(ic.documentId),&#10;                label: ic.name&#10;            })),&#10;            impacts: (projectOptions.impacts ?? []).map(imp =&gt; ({&#10;                value: String(imp.documentId),&#10;                label: imp.name&#10;            })),&#10;            sdgs: (projectOptions.sdgs ?? []).map(sdg =&gt; ({&#10;                value: String(sdg.documentId),&#10;                label: sdg.name&#10;            })),&#10;            departments: (projectOptions.departments ?? []).filter(d =&gt; d.title !== 'สํานักงานเลขานุการ').map(dep =&gt; ({&#10;                value: String(dep.documentId),&#10;                label: dep.title&#10;            }))&#10;        };&#10;    }, [projectOptions]);&#10;&#10;    // Update options state only when memoizedOptions change&#10;    useEffect(() =&gt; {&#10;        setIcTypesOptions(memoizedOptions.icTypes);&#10;        setImpactsOptions(memoizedOptions.impacts);&#10;        setSdgsOptions(memoizedOptions.sdgs);&#10;        setDepartmentsOptions(memoizedOptions.departments);&#10;    }, [memoizedOptions]);&#10;&#10;    // Early return with loading state and error handling&#10;    if (status === 'loading' || projectOptionsLoading) {&#10;        return &lt;div className=&quot;flex items-center justify-center p-8&quot;&gt;&#10;            &lt;p&gt;Loading form...&lt;/p&gt;&#10;        &lt;/div&gt;;&#10;    }&#10;&#10;    if (projectOptionsError) {&#10;        return &lt;div className=&quot;flex items-center justify-center p-8&quot;&gt;&#10;            &lt;p className=&quot;text-red-600&quot;&gt;Error loading form options. Please refresh the page.&lt;/p&gt;&#10;        &lt;/div&gt;;&#10;    }&#10;&#10;    if (!formData) {&#10;        return &lt;div className=&quot;flex items-center justify-center p-8&quot;&gt;&#10;            &lt;p&gt;Initializing form...&lt;/p&gt;&#10;        &lt;/div&gt;;&#10;    }&#10;&#10;    return (&#10;        &lt;&gt;&#10;            &lt;Block&gt;&#10;                &lt;div className=&quot;inputGroup&quot;&gt;&#10;                    &lt;FormInput id=&quot;fiscalYear&quot; label=&quot;ปีงบประมาณ&quot; value={formData.fiscalYear} placeholder=&quot;กรอกปีงบประมาณ&quot; onChange={(e) =&gt; handleInputChange('fiscalYear', e.target.value)} /&gt;&#10;                    &lt;FormRadio id=&quot;projectType&quot; label=&quot;ประเภทโครงการ&quot; value={formData.projectType} onChange={(e) =&gt; handleInputChange('projectType', e.target.value)} options={[&#10;                        { value: '0', label: 'โครงการวิจัย' },&#10;                        { value: '1', label: 'โครงการพัฒนาวิชาการประเภทงานวิจัย' },&#10;                    ]} /&gt;&#10;                    &lt;FormRadio id=&quot;projectMode&quot; label=&quot;ลักษณะโครงการวิจัย&quot; value={formData.projectMode} onChange={(e) =&gt; handleInputChange('projectMode', e.target.value)} options={[&#10;                        { value: '0', label: 'โครงการวิจัยเดี่ยว' },&#10;                        { value: '1', label: 'แผนงานวิจัย หรือชุดโครงการวิจัย' },&#10;                    ]} /&gt;&#10;                    &lt;FormInput id=&quot;subProjectCount&quot; disabled={formData.projectMode == '0' || formData.projectMode == ''} type=&quot;number&quot; label=&quot;จำนวนโครงการย่อย&quot; value={formData.subProjectCount} placeholder=&quot;กรอกจำนวนโครงการย่อย&quot; onChange={(e) =&gt; handleInputChange('subProjectCount', e.target.value)} /&gt;&#10;                    {/* &lt;FormInput id=&quot;project-name&quot; label=&quot;ชื่อโครงการ&quot; value=&quot;&quot; placeholder=&quot;กรอกชื่อโครงการ&quot; /&gt; */}&#10;                    &lt;FormTextarea id=&quot;nameTH&quot; label=&quot;ชื่อแผนงานวิจัยหรือชุดโครงการวิจัย/โครงการวิจัย (ไทย)&quot; value={formData.nameTH} onChange={(e) =&gt; handleInputChange('nameTH', e.target.value)} placeholder=&quot;&quot; rows={5} /&gt;&#10;                    &lt;FormTextarea id=&quot;nameEN&quot; label=&quot;ชื่อแผนงานวิจัยหรือชุดโครงการวิจัย/โครงการวิจัย (อังกฤษ)&quot; value={formData.nameEN} onChange={(e) =&gt; handleInputChange('nameEN', e.target.value)} placeholder=&quot;&quot; rows={5} /&gt;&#10;                    &lt;FormRadio id=&quot;isEnvironmentallySustainable&quot; label=&quot;&quot; value={formData.isEnvironmentallySustainable} onChange={(e) =&gt; handleInputChange('isEnvironmentallySustainable', e.target.value)} options={[&#10;                        { value: '0', label: 'เกี่ยวข้อง กับสิ่งแวดล้อมและความยั่งยืน' },&#10;                        { value: '1', label: 'ไม่เกี่ยวข้อง กับสิ่งแวดล้อมและความยั่งยืน' },&#10;                    ]} /&gt;&#10;                    &lt;FormDateSelect durationStart={formData.durationStart} durationEnd={formData.durationEnd} durationStartChange={(field, value) =&gt; handleInputChange(field, value)} durationEndChange={(field, value) =&gt; handleInputChange(field, value)} noDay={false}&gt;&#10;                        ระยะเวลาการทำวิจัย{&quot; &quot;}&#10;                        &lt;span className=&quot;text-blue-700&quot;&gt;(ปี พ.ศ. 4 หลัก)&lt;/span&gt;&#10;                        &lt;span className=&quot;text-red-500 ml-1&quot;&gt;*&lt;/span&gt;&#10;                    &lt;/FormDateSelect&gt;&#10;                    {/* &lt;FormTextarea id=&quot;responsibleOrganization&quot; label=&quot;หน่วยงานหลักที่รับผิดชอบโครงการวิจัย (หน่วยงานที่ขอทุน)&quot; value={formData.responsibleOrganization} onChange={(e) =&gt; handleInputChange('responsibleOrganization', e.target.value)} placeholder=&quot;&quot; rows={5} /&gt; */}&#10;                    &lt;FormSelect id=&quot;departments&quot; label=&quot;หน่วยงานหลักที่รับผิดชอบโครงการวิจัย (หน่วยงานที่ขอทุน)&quot; value={formData.departments ?? &quot;&quot;} placeholder=&quot;เลือกหน่วยงาน&quot; onChange={(val) =&gt; handleInputChange('departments', val)} options={departmentsOptions} /&gt;&#10;                    &lt;FormSelect id=&quot;researchKind&quot; label=&quot;ประเภทงานวิจัย&quot; value={formData.researchKind ?? &quot;&quot;} placeholder=&quot;เลือกประเภทงานวิจัย&quot; onChange={(val) =&gt; handleInputChange('researchKind', val)} options={researchKindOptions} /&gt;&#10;                    &lt;FormSelect id=&quot;fundType&quot; label=&quot;ประเภทแหล่งทุน&quot; disabled={formData.researchKind == &quot;&quot;} value={formData.fundType ?? &quot;&quot;} placeholder=&quot;เลือกประเภทแหล่งทุน&quot; onChange={(val) =&gt; handleInputChange('fundType', val)} options={fundTypeOptions} /&gt;&#10;                    {fundSubTypeOptions.length &gt; 0 &amp;&amp; (&#10;                        &lt;FormSelect id=&quot;fundSubType&quot; label=&quot; &quot; value={formData.fundSubType ?? &quot;&quot;} placeholder=&quot;เลือกประเภทแหล่งทุน&quot; onChange={(val) =&gt; handleInputChange('fundSubType', val)} options={fundSubTypeOptions} /&gt;&#10;                    )}&#10;                    &lt;FormSelect id=&quot;fundName&quot; label=&quot;ชื่อแหล่งทุน&quot; disabled={formData.fundSubType == &quot;&quot;} value={fundNameSelectValue} placeholder=&quot;ชื่อแหล่งทุน&quot; onChange={(val) =&gt; handleInputChange('fundName', val)} options={fundNameOptions} /&gt;&#10;                    {isFundNameOther &amp;&amp; (&#10;                        &lt;FormTextarea&#10;                            label=&quot;ระบุชื่อแหล่งทุน&quot;&#10;                            value={formData.fundName === 'อื่นๆ' ? '' : formData.fundName}&#10;                            onChange={(e) =&gt; handleInputChange('fundName', e.target.value)}&#10;                            placeholder=&quot;กรุณาระบุชื่อแหล่งทุน&quot;&#10;                            rows={3}&#10;                        /&gt;&#10;                    )}&#10;                    &lt;FormInput id=&quot;budget&quot; type='number' label=&quot;งบวิจัย&quot; value={formData.budget} placeholder=&quot;0&quot; onChange={(e) =&gt; handleInputChange('budget', e.target.value)} /&gt;&#10;                    &lt;FormTextarea id=&quot;keywords&quot; label=&quot;คำสำคัญ (คั่นระหว่างคำด้วยเครื่องหมาย “;” เช่น ข้าว; พืช; อาหาร)&quot; value={formData.keywords} onChange={(e) =&gt; handleInputChange('keywords', e.target.value)} placeholder=&quot;&quot; rows={5} /&gt;&#10;                    &lt;FormSelect id=&quot;icTypes&quot; label=&quot;IC Types&quot; value={formData.icTypes ?? &quot;&quot;} placeholder=&quot;เลือก IC Types&quot; onChange={(val) =&gt; handleInputChange('icTypes', val)} options={icTypesOptions} /&gt;&#10;                    &lt;FormSelect id=&quot;impact&quot; label=&quot;Impact&quot; value={formData.impact ?? &quot;&quot;} placeholder=&quot;เลือก Impact&quot; onChange={(val) =&gt; handleInputChange('impact', val)} options={impactsOptions} /&gt;&#10;                    &lt;FormMultiSelect id=&quot;sdgs&quot; label=&quot;SDG&quot; value={formData.sdg ?? []} placeholder=&quot;เลือก SDG&quot; onChange={(val) =&gt; handleInputChange('sdg', val)} options={sdgsOptions} /&gt;&#10;                    &lt;FileUploadField&#10;                        label=&quot;เอกสารแนบ&quot;&#10;                        value={formData.attachments || []}&#10;                        onFilesChange={(files) =&gt; handleInputChange('attachments', files)}&#10;                    /&gt;&#10;                &lt;/div&gt;&#10;            &lt;/Block&gt;&#10;            &lt;Block className=&quot;mt-4&quot;&gt;&#10;                &lt;Partners data={formData.partners} onChange={(partners) =&gt; handleInputChange('partners', partners)} /&gt;&#10;            &lt;/Block&gt;&#10;            &lt;div className='flex justify-end items-center gap-3 mt-4'&gt;&#10;                &lt;Button onClick={() =&gt; router.back()} variant=&quot;outline&quot;&gt;ยกเลิก&lt;/Button&gt;&#10;                &lt;Button&#10;                    variant=&quot;default&quot;&#10;                    onClick={handleSubmit}&#10;                    disabled={isSubmitting}&#10;                &gt;&#10;                    {isSubmitting ? 'กำลังบันทึก...' : 'บันทึก'}&#10;                &lt;/Button&gt;&#10;            &lt;/div&gt;&#10;        &lt;/&gt;&#10;    );&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>